name: Build & Deploy
on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js environment
      uses: actions/setup-node@v3.6.0
      with:
        node-version: '16.x'

    - name: Install dependencies
      run: npm i

    - name: Build app
      run: npm run build
      
    - name: Generate Dockerfile
      run: |
        echo 'FROM nginx:latest' >> Dockerfile
        
        echo 'EXPOSE 80' >> Dockerfile
        cat Dockerfile

    - name: Build Docker image
      uses: docker/build-push-action@v4.0.0
      with:
        context: .
        push: false

    - name: Create archive
      run: tar -czf app.tar.gz dist

    

    - name: SSH Server Deploy
      # You may pin to the exact commit or the version.
      # uses: kostyaten/ssh-server-deploy@e0deb814bc458a68b61f6597a865d096e33eb586
      uses: kostyaten/ssh-server-deploy@v4
      with:
        host: ssh.alpha-ome.ga
        port: 500
        username: admin
        password: ${{ secrets.SSH_PASSWORD }}
        after_script: |
          sudo docker import app.tar.gz quickshare-frontend:latest
          sudo docker run --name quickshare-frontend --restart unless-stopped -p 80:80 -d quickshare-frontend:latest nginx -g daemon off
        scp_source: app.tar.gz
        scp_target: app.tar.gz
